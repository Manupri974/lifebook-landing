<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interview LifeBook</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script type="module" src="https://esm.sh/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      background: #fefefe;
      color: #333;
    }
    #chat {
      max-width: 700px;
      margin: auto;
    }
    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
    }
    .bot { background: #f3e8fa; color: #5a2a82; }
    .user { background: #e1f5e8; color: #21543d; text-align: right; }
    #progression {
      margin-top: 10px;
      font-size: 0.9em;
      text-align: right;
      color: #777;
    }
    textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
      resize: vertical;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      margin-right: 10px;
      border: none;
      border-radius: 6px;
      background: #a347ba;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: #912ca3; }
    #waveform {
      width: 100%;
      height: 6px;
      background: linear-gradient(90deg, #a347ba 50%, #fff 50%);
      background-size: 20px 100%;
      background-repeat: repeat-x;
      animation: wave 1s linear infinite;
      display: none;
      margin: 10px 0;
      border-radius: 4px;
    }
    @keyframes wave {
      0% { background-position: 0 0; }
      100% { background-position: 20px 0; }
    }
  </style>
</head>
<body>
<div id="chat">
  <div id="messages"></div>
  <div id="progression">Question 1 / 89</div>
  <textarea id="userInput" rows="2" placeholder="Votre r√©ponse..."></textarea>
  <div>
    <button onclick="sendMessage()">Envoyer</button>
    <button onclick="passerQuestion()">Passer √† la question suivante</button>
    <button onclick="genererLivre()">Terminer et g√©n√©rer</button>
    <button onclick="sauvegarder()">üíæ Sauvegarder</button>
  </div>
  <div style="margin-top:20px">
    <button id="speechButton" onclick="toggleRecording()">üéôÔ∏è Parler</button>
    <div id="waveform"></div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js'

  const supabase = createClient(
    'https://qgmxclxahaqnvvxhgcms.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... (ta cl√© publique)'
  )

  let historique = []
  let questionIndex = 0
  let recognition, recording = false

  function afficher(auteur, texte, classe) {
    const msg = document.createElement("div")
    msg.className = "message " + classe
    msg.innerHTML = `<strong>${auteur} :</strong> ${texte}`
    document.getElementById("messages").appendChild(msg)
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight
  }

  function miseAJourProgression() {
    document.getElementById("progression").innerText = `Question ${questionIndex + 1} / 89`
  }

  async function sendMessage() {
    const input = document.getElementById("userInput")
    const text = input.value.trim()
    if (!text) return
    afficher("Vous", text, "user")
    historique.push({ role: "user", content: text })
    input.value = ""

    const response = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: historique })
    })

    const data = await response.json()
    const botText = data.reply

    afficher("LifeBook", botText, "bot")
    historique.push({ role: "assistant", content: botText })
    questionIndex++
    miseAJourProgression()
  }

  function passerQuestion() {
    historique.push({ role: "user", content: "passons" })
    sendMessage()
  }

  async function sauvegarder() {
    const { data: { session } } = await supabase.auth.getSession()
    if (!session) return alert("Non connect√©.")
    const user = session.user

    const { error } = await supabase.from('responses').insert([{
      user_id: user.id,
      content: historique
    }])
    if (error) {
      alert("Erreur de sauvegarde.")
    } else {
      alert("Sauvegarde r√©ussie !")
    }
  }

  async function genererLivre() {
    const prompt = `R√©dige un texte biographique litt√©raire √† partir des r√©ponses suivantes :\n\n${historique.filter(m => m.role === 'user').map(m => m.content).join('\n')}`

    const response = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: [
          { role: "system", content: "Tu es un √©crivain biographe. Transforme les r√©ponses suivantes en une narration fluide, litt√©raire et √©motive, dans l‚Äôordre chronologique." },
          { role: "user", content: prompt }
        ]
      })
    })

    const data = await response.json()
    const { jsPDF } = window.jspdf
    const doc = new jsPDF()
    const lines = doc.splitTextToSize(data.reply, 180)
    doc.text(lines, 15, 20)
    doc.save("LifeBook.pdf")
  }

  async function initChat() {
    const response = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: [] })
    })
    const data = await response.json()
    afficher("LifeBook", data.reply, "bot")
    historique.push({ role: "assistant", content: data.reply })
  }

  function toggleRecording() {
    const button = document.getElementById("speechButton")
    const waveform = document.getElementById("waveform")

    if (!recording) {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)()
      recognition.lang = "fr-FR"
      waveform.style.display = "block"
      button.textContent = "üõë Stop"
      recording = true

      recognition.onresult = function (event) {
        const result = event.results[0][0].transcript
        document.getElementById("userInput").value = result
        waveform.style.display = "none"
        button.textContent = "üéôÔ∏è Parler"
        recording = false
        sendMessage()
      }

      recognition.onerror = function () {
        waveform.style.display = "none"
        button.textContent = "üéôÔ∏è Parler"
        recording = false
      }

      recognition.start()
    } else {
      recognition.stop()
      waveform.style.display = "none"
      button.textContent = "üéôÔ∏è Parler"
      recording = false
    }
  }

  window.onload = initChat
</script>
</body>
</html>
