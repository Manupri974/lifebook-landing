import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent } from "@/components/ui/card";

export default function LifeBook() {
  const [messages, setMessages] = useState([
    { from: "bot", text: "Bienvenue dans LifeBook. Offrez un livre de souvenirs à vos proches. Pour commencer : Où êtes-vous né(e) ?" }
  ]);
  const [input, setInput] = useState("");
  const [conversationLog, setConversationLog] = useState([
    { role: "bot", text: "Bienvenue dans LifeBook. Offrez un livre de souvenirs à vos proches. Pour commencer : Où êtes-vous né(e) ?" }
  ]);

  const handleSend = async () => {
    if (!input.trim()) return;
    const userMessage = { from: "user", text: input };
    const updatedMessages = [...messages, userMessage];
    const updatedLog = [...conversationLog, { role: "user", text: input }];
    setMessages(updatedMessages);
    setConversationLog(updatedLog);
    setInput("");

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages: buildMessages(updatedLog) })
      });

      const data = await res.json();
      const botReply = { from: "bot", text: data.reply };
      setMessages([...updatedMessages, botReply]);
      setConversationLog([...updatedLog, { role: "bot", text: data.reply }]);
    } catch (err) {
      console.error("Erreur :", err);
    }
  };

  const buildMessages = (log) => [
    { role: "system", content: "Tu es un biographe bienveillant. Pose des questions personnelles pour écrire un livre de souvenirs. Pose une question à la fois." },
    ...log.map(msg => ({ role: msg.role === "bot" ? "assistant" : "user", content: msg.text }))
  ];

  const generatePdf = async () => {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: [
          { role: "system", content: "Tu es un écrivain littéraire. Rédige un récit biographique fluide et touchant à partir de cette conversation." },
          { role: "user", content: JSON.stringify(conversationLog) }
        ]
      })
    });

    const data = await res.json();
    const jsPDF = (await import("jspdf")).jsPDF;
    const doc = new jsPDF();
    const lines = doc.splitTextToSize(data.reply, 180);
    doc.text(lines, 10, 10);
    doc.save("lifebook.pdf");
  };

  return (
    <div className="max-w-2xl mx-auto mt-10 p-4">
      <h1 className="text-3xl font-bold mb-6 text-center text-purple-700">LifeBook</h1>
      <div className="space-y-4 mb-4">
        {messages.map((msg, index) => (
          <Card key={index} className={msg.from === "user" ? "bg-blue-50" : "bg-purple-50"}>
            <CardContent className="p-4">
              <p><strong>{msg.from === "bot" ? "LifeBook" : "Vous"}:</strong> {msg.text}</p>
            </CardContent>
          </Card>
        ))}
      </div>
      <div className="flex gap-2 mb-4">
        <Input
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder="Écrivez votre réponse ici..."
        />
        <Button onClick={handleSend}>Envoyer</Button>
      </div>
      <div className="text-center">
        <Button variant="secondary" onClick={generatePdf}>Terminer et générer</Button>
      </div>
    </div>
  );
}
